amends "package://github.com/jdx/hk/releases/download/v1.0.0/hk@1.0.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.0.0/hk@1.0.0#/Builtins.pkl"

local elixir_files = List("*.ex", "*.exs")

local elixir_stage = (Step) {
  glob =
  exclude = List("deps/**/*")
  stage = elixir_files
}

local linters = new Mapping<String, Step> {
  ["prettier"] = (Builtins.prettier) {
    batch = false
  }
  ["mix compile"] = (elixir_stage) {
    check = "mix compile --warnings-as-errors --strict-warnings"
  }
  ["mix format"] = (elixir_stage) {
    check = "mix format --check-formatted {{files}}"
    fix = "mix format {{files}}"
    depends = List("mix compile")
  }
  ["pkl"] {
    glob = "*.pkl"
    check = "pkl eval {{files}} >/dev/null"
  }
}

hooks {
  ["pre-commit"] {
    fix = true
    stash = "patch-file"
    steps = linters
  }
  ["fix"] {
    fix = true
    stash = "patch-file"
    steps = linters
  }
  ["check"] {
    steps = linters
  }
}
